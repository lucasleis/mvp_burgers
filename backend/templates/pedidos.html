<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Panel de Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .pedido-detalle {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 10px 15px;
      margin-top: 10px;
    }
    .pedido-item {
      margin-bottom: 6px;
    }
    .pedido-item small {
      color: #555;
    }
    .pedido-comentario {
      background-color: #fff3cd;
      border-left: 4px solid #ffca2c;
      padding: 8px 10px;
      border-radius: 4px;
      font-style: italic;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">

    <a href="/api/admin" class="btn btn-secondary mb-4">‚Üê Volver al Administrador</a>

    <h1>Panel de Pedidos</h1>
    <div class="row">
      <!-- üü† Pendientes -->
      <div class="col-md-6">
        <h3>Pendientes</h3>
        {% for pedido in pendientes %}
        <div class="card mb-3 p-3">
          <p><strong>Pedido N¬∞:</strong> {{ pedido.id }}</p>
          <p><strong>Cliente:</strong> {{ pedido.cliente or '‚Äî' }}</p>
          <p><strong>M√©todo de env√≠o:</strong> {{ pedido.metodo_envio }}</p>
          <p><strong>Direcci√≥n:</strong> {{ pedido.direccion }}</p>
          <p><strong>Entrega estimada:</strong> {{ pedido.tiempo_entrega or 'No especificado' }}</p>
          <p><strong>Tel√©fono:</strong> {{ pedido.telefono }}</p>
          <p><strong>M√©todo de pago:</strong> {{ pedido.metodo_pago }}</p>
          <p><strong>Total:</strong> ${{ pedido.total }}</p>

          <!-- üßæ Detalle del pedido -->
          {% if pedido.detalle %}
            <div class="mt-3">

              <button class="btn btn-sm btn-outline-primary w-100"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#detalle-{{ pedido.id }}"
                aria-expanded="false"
                aria-controls="detalle-{{ pedido.id }}">
                Ver detalle del pedido
              </button>

              <div class="collapse mt-2" id="detalle-{{ pedido.id }}">
                <div class="pedido-detalle">

                  {% for item in pedido.detalle %}
                  <div class="pedido-item">
                    <strong>{{ item.name }}</strong> x{{ item.quantity }}
                    <span>- ${{ item.totalPrice }}</span><br>

                    {% if item.extras %}
                    <small>+ Extras:
                      {% for e in item.extras %}
                        {{ e[0] }} x{{ e[1] }}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    </small><br>
                    {% endif %}

                    {% if item.removed %}
                    <small>- Sin:
                      {% for r in item.removed %}
                        {{ r }}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    </small>
                    {% endif %}
                  </div>
                  {% endfor %}

                </div>
              </div>

            </div>
          {% endif %}


          {% if pedido.comentarios %}
          <div class="pedido-comentario mt-2">
            üí¨ {{ pedido.comentarios }}
          </div>
          {% endif %}

          <form method="post" action="/api/admin/enviar/{{ pedido.id }}" class="state-form mt-3" data-msg="¬øMarcar este pedido como Enviado?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-success w-100">Marcar como Enviado</button>
          </form>
        </div>
        {% endfor %}
      </div>

      <!-- üü¢ Enviados -->
      <div class="col-md-6">
        <h3>Enviados</h3>
        {% for pedido in enviados %}
        <div class="card mb-3 p-3 bg-light">
          <p><strong>Pedido N¬∞:</strong> {{ pedido.id }}</p>
          <p><strong>Cliente:</strong> {{ pedido.cliente or '‚Äî' }}</p>
          <p><strong>M√©todo de env√≠o:</strong> {{ pedido.metodo_envio }}</p>
          <p><strong>Direcci√≥n:</strong> {{ pedido.direccion }}</p>
          <p><strong>Entrega estimada:</strong> {{ pedido.tiempo_entrega or 'No especificado' }}</p>
          <p><strong>Tel√©fono:</strong> {{ pedido.telefono }}</p>
          <p><strong>M√©todo de pago:</strong> {{ pedido.metodo_pago }}</p>
          <p><strong>Total:</strong> ${{ pedido.total }}</p>

          {% if pedido.detalle %}
            <div class="mt-3">

              <button class="btn btn-sm btn-outline-primary w-100"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#detalle-{{ pedido.id }}"
                      aria-expanded="false"
                      aria-controls="detalle-{{ pedido.id }}">
                Ver detalle del pedido
              </button>

              <div class="collapse mt-2" id="detalle-{{ pedido.id }}">
                <div class="pedido-detalle">

                  {% for item in pedido.detalle %}
                  <div class="pedido-item">
                    <strong>{{ item.name }}</strong> x{{ item.quantity }}
                    <span>- ${{ item.totalPrice }}</span><br>

                    {% if item.extras %}
                    <small>+ Extras:
                      {% for e in item.extras %}
                        {{ e[0] }} x{{ e[1] }}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    </small><br>
                    {% endif %}

                    {% if item.removed %}
                    <small>- Sin:
                      {% for r in item.removed %}
                        {{ r }}{% if not loop.last %}, {% endif %}
                      {% endfor %}
                    </small>
                    {% endif %}
                  </div>
                  {% endfor %}

                </div>
              </div>

            </div>
          {% endif %}



          {% if pedido.comentarios %}
          <div class="pedido-comentario mt-2">
            üí¨ {{ pedido.comentarios }}
          </div>
          {% endif %}

          <form method="post" action="/api/admin/pendiente/{{ pedido.id }}" class="state-form mt-3" data-msg="¬øVolver este pedido a Pendiente?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-warning w-100">Volver a Pendiente</button>
          </form>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    // Confirmaciones seguras
    document.querySelectorAll('.state-form').forEach(form => {
      form.addEventListener('submit', e => {
        if (!confirm(form.dataset.msg)) e.preventDefault();
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
