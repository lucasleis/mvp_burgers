<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Panel de Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pedidos.css') }}">
</head>

<body class="p-4">
  <div class="container">

    <a href="/api/admin" class="btn btn-secondary mb-4">← Volver al Administrador</a>

    <h1>Panel de Pedidos</h1>
    <div class="row">

      <!-- PENDIENTES -->
      <div class="col-md-6">
        <h3>Pendientes</h3>

        {% for pedido in pendientes %}
        <div class="card mb-3 p-3">

          <!-- ENCABEZADO -->
          <p><strong>Pedido N°:</strong> {{ pedido.id }} - {{ pedido.cliente or '—' }}</p>
          <!-- <p><strong>Cliente:</strong> {{ pedido.cliente or '—' }}</p> -->
          <p><strong>Método de envío:</strong> {{ pedido.metodo_envio }}</p>

          <!-- TOTAL + MÉTODO DE PAGO -->
          <p class="mt-2">
            <strong>Total:</strong> ${{ pedido.total }} — {{ pedido.metodo_pago }}
          </p>

          <!-- DETALLE DEL PEDIDO -->
          {% if pedido.detalle %}
          <p><strong>Pedido:</strong></p>

          <div class="pedido-detalle mb-3">
            {% for item in pedido.detalle %}
            <div class="pedido-item">
              <strong>{{ item.name }}</strong> x{{ item.quantity }}
              <span>- ${{ item.totalPrice }}</span><br>

              {% if item.extras %}
              <small>+ Extras:
                {% for e in item.extras %}
                  {{ e[0] }} x{{ e[1] }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small><br>
              {% endif %}

              {% if item.removed %}
              <small>- Sin:
                {% for r in item.removed %}
                  {{ r }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <!-- BOTÓN PARA INFO -->
          <button class="btn btn-sm btn-outline-primary w-100"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#info-{{ pedido.id }}"
            aria-expanded="false"
            aria-controls="info-{{ pedido.id }}">
            Ver info del pedido
          </button>

          <!-- INFO EXTRA -->
          <div class="collapse mt-2" id="info-{{ pedido.id }}">
            <p><strong>Dirección:</strong> {{ pedido.direccion }}</p>
            <p><strong>Entrega estimada:</strong> {{ pedido.tiempo_entrega or 'No especificado' }}</p>
            <p><strong>Teléfono:</strong> {{ pedido.telefono }}</p>

            {% if pedido.comentarios %}
            <p><strong>Comentarios:</strong> {{ pedido.comentarios }}</p>
            {% endif %}
          </div>

          <!-- CAMBIAR ESTADO -->
          <form method="post" action="/api/admin/enviar/{{ pedido.id }}" class="state-form mt-3" data-msg="¿Marcar este pedido como Enviado?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-success w-100">Marcar como Enviado</button>
          </form>

        </div>
        {% endfor %}
      </div>

      <!-- ENVIADOS -->
      <div class="col-md-6">
        <h3>Enviados</h3>

        {% for pedido in enviados %}
        <div class="card mb-3 p-3 bg-light">

          <!-- ENCABEZADO -->
          <p><strong>Pedido N°:</strong> {{ pedido.id }}</p>
          <p><strong>Cliente:</strong> {{ pedido.cliente or '—' }}</p>
          <p><strong>Método de envío:</strong> {{ pedido.metodo_envio }}</p>

          <!-- DETALLE SIEMPRE VISIBLE -->
          {% if pedido.detalle %}
          <p><strong>Pedido:</strong></p>

          <div class="pedido-detalle mb-3">
            {% for item in pedido.detalle %}
            <div class="pedido-item">
              <strong>{{ item.name }}</strong> x{{ item.quantity }}
              <span>- ${{ item.totalPrice }}</span><br>

              {% if item.extras %}
              <small>+ Extras:
                {% for e in item.extras %}
                  {{ e[0] }} x{{ e[1] }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small><br>
              {% endif %}

              {% if item.removed %}
              <small>- Sin:
                {% for r in item.removed %}
                  {{ r }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <!-- TOTAL + MÉTODO DE PAGO -->
          <p class="mt-2">
            <strong>Total:</strong> ${{ pedido.total }} — {{ pedido.metodo_pago }}
          </p>

          <!-- BOTÓN PARA INFO -->
          <button class="btn btn-sm btn-outline-primary w-100"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#info-enviado-{{ pedido.id }}"
            aria-expanded="false"
            aria-controls="info-enviado-{{ pedido.id }}">
            Ver info del pedido
          </button>

          <!-- INFO EXTRA -->
          <div class="collapse mt-2" id="info-enviado-{{ pedido.id }}">
            <p><strong>Dirección:</strong> {{ pedido.direccion }}</p>
            <p><strong>Entrega estimada:</strong> {{ pedido.tiempo_entrega or 'No especificado' }}</p>
            <p><strong>Teléfono:</strong> {{ pedido.telefono }}</p>

            {% if pedido.comentarios %}
            <p><strong>Comentarios:</strong> {{ pedido.comentarios }}</p>
            {% endif %}
          </div>

          <!-- CAMBIAR ESTADO -->
          <form method="post" action="/api/admin/pendiente/{{ pedido.id }}" class="state-form mt-3" data-msg="¿Volver este pedido a Pendiente?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-warning w-100">Volver a Pendiente</button>
          </form>

        </div>
        {% endfor %}
      </div>

    </div>
  </div>

  <!-- 
  <script>
    // Confirmaciones seguras
    document.querySelectorAll('.state-form').forEach(form => {
      form.addEventListener('submit', e => {
        if (!confirm(form.dataset.msg)) e.preventDefault();
      });
    });
  </script>
  `-->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
